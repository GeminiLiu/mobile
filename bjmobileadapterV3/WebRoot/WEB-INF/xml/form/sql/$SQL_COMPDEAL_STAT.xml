<?xml version="1.0" encoding="GB2312"?>
<sql-group>
	<doc>
		<description>分公司统计</description>
	</doc>
	
	<!-- 投诉类型217-->
	<sql name="compdeal.businesstype" datasource="Ultranms">
		<item dbms="All">
		<![CDATA[
		select distinct ty.c801800001 from {table} ty
		]]></item>
	</sql>	

<sql name="compdeal.result" datasource="Ultranms">
<item dbms="All"><![CDATA[
		
select
distinct(comp.C801000018) as 处理客服,
sum(case when pro.C700020004='BEGIN' then 1 else 0 end) as 工单生成,
sum(case when pro.C801000101=1 or pro.C801000101=4 then 1 else 0 end) as 派单量,
sum(case when (pro.C801000101=1 or pro.C801000101=4) and pro.C700020017-pro.C700020014<=0 then 1 else 0 end) as 及时派单量,
round(sum(case when (pro.C801000101=1 or pro.C801000101=4) and pro.C700020017-pro.C700020014<=0 then 1 else 0 end)/(case when sum(case when pro.C801000101=1 or pro.C801000101=4 then 1 else 0 end)=0 then 1 else sum(case when pro.C801000101=1 or pro.C801000101=4 then 1 else 0 end) end)*100,2) || '%' as 及时派单率,
sum(case when pro.C801000101 in (5,6,7,9) then 1 else 0 end) as 处理量,
sum(case when pro.C801000101 in (5,6,7,9) and pro.C700020017-pro.C700020014<=0 then 1 else 0 end) as 及时处理量,
round(sum(case when pro.C801000101 in (5,6,7,9) and pro.C700020017-pro.C700020014<=0 then 1 else 0 end)/(case when sum(case when pro.C801000101 in (5,6,7,9) then 1 else 0 end)=0 then 1 else sum(case when pro.C801000101 in (5,6,7,9) then 1 else 0 end) end)*100,2) ||'%' as 及时处理率,
sum(case when pro.C801000101=8 then 1 else 0 end) as 反馈量,
sum(case when pro.C801000101=8 and pro.C700020017-pro.C700020014<=0 then 1 else 0 end) as 及时反馈量,
round(sum(case when pro.C801000101=8 and pro.C700020017-pro.C700020014<=0 then 1 else 0 end)/(case when sum(case when pro.C801000101=8 then 1 else 0 end)=0 then 1 else sum(case when pro.C801000101=8 then 1 else 0 end) end)*100,2) ||'%' as 及时反馈率
from {table1} comp,{table2} pro
where
comp.C1=pro.C700020001
and comp.c700000007 > {start} and comp.c700000007 < {end}
{compdeal.businesstype}
group by comp.C801000018

union all
 
select
distinct(comp.C801000018) as 处理客服,
sum(case when pro.C700020004='BEGIN' then 1 else 0 end) as 工单生成,
sum(case when pro.C801000101=1 or pro.C801000101=4 then 1 else 0 end) as 派单量,
sum(case when (pro.C801000101=1 or pro.C801000101=4) and pro.C700020017-pro.C700020014<=0 then 1 else 0 end) as 及时派单量,
round(sum(case when (pro.C801000101=1 or pro.C801000101=4) and pro.C700020017-pro.C700020014<=0 then 1 else 0 end)/sum(case when pro.C801000101=1 or pro.C801000101=4 then 1 else 0 end)*100,2) || '%' as 及时派单率,
sum(case when pro.C801000101 in (5,6,7,9) then 1 else 0 end) as 处理量,
sum(case when pro.C801000101 in (5,6,7,9) and pro.C700020017-pro.C700020014<=0 then 1 else 0 end) as 及时处理量,
round(sum(case when pro.C801000101 in (5,6,7,9) and pro.C700020017-pro.C700020014<=0 then 1 else 0 end)/sum(case when pro.C801000101 in (5,6,7,9) then 1 else 0 end)*100,2) ||'%' as 及时处理率,
sum(case when pro.C801000101=8 then 1 else 0 end) as 反馈量,
sum(case when pro.C801000101=8 and pro.C700020017-pro.C700020014<=0 then 1 else 0 end) as 及时反馈量,
round(sum(case when pro.C801000101=8 and pro.C700020017-pro.C700020014<=0 then 1 else 0 end)/(case when sum(case when pro.C801000101=8 then 1 else 0 end)=0 then 1 else sum(case when pro.C801000101=8 then 1 else 0 end) end)*100,2) ||'%' as 及时反馈率
from {table1} comp,{table3} pro
where
comp.C1=pro.C700020001
and comp.c700000007 > {start} and comp.c700000007 < {end}
{compdeal.businesstype}
group by comp.C801000018

]]></item>
</sql>
	
	
</sql-group>