<?xml version="1.0" encoding="UTF-8"?>
<sql-group>
	<doc>
		<author>chengshanlong</author>
		<date>2010-09-26</date>
		<description>网络工程割接情况统计</description>
	</doc>
	<sqlquery name="SQL_WorkCostAssessedTarget">
		<select>
		<![CDATA[ 
  				
	       select rs3.gname as dpName,
	        rs3.id as dpid,
	        nvl(rs1.total,0) as finished,
	        case when nvl(rs1.total,0)<>0 then round(nvl(rs1.finished,0)/nvl(rs1.total,0),4)*100 || '%' else '0%' end as paifalv,
	        nvl(rs1.zhijian,0) as zhijianshu,
	        case when nvl(rs1.total,0)<>0 then round(nvl(rs1.zhijian,0)/nvl(rs1.total,0),4)*100 || '%' else '0%' end as zhijian,
	        nvl(rs1.jishishu,0) as jishushu, 
	        case when nvl(rs1.total,0)<>0 then round(nvl(rs1.jishishu,0)/nvl(rs1.total,0),4)*100 || '%' else '0%' end as jishilv,
	        case when nvl(rs1.total,0)<>0 then round(nvl(rs4.total,0)/nvl(rs1.total,0),4)*100 || '%' else '0%' end as querenlv,
	        nvl(rs2.phoneTotal,0) as phoneTotal,
	        case when nvl(rs2.phoneAll,0)<>0 then round(nvl(rs2.phoneTotal,0)/nvl(rs2.phoneAll,0),4)*100 || '%' else '0%' end as phoneAlls,
	        nvl(rs2.notNotes,0) as notNotes,
	        case when nvl(rs2.phoneAll,0)<>0 then round(nvl(rs2.notNotes,0)/nvl(rs2.phoneAll,0),4)*100 || '%' else '0%' end as notices,
	        nvl(rs1.total,0)+nvl(rs2.notNotes,0)+nvl(rs2.phoneTotal,0) as fromTotals
	       from 
			 (select g.c630000018 as dp,
			        ltrim(g.c1,0) as dpid,
			        count(*) as total,
			        sum(case when t1.c700000010 = '已完成' or t1.c700000010 = '已归档' then 1 else 0 end) as finished,
			        sum(case when (t1.c700000010 = '已完成' or t1.c700000010 = '已归档') and t1.c800052001=0 then 1 else 0 end) as zhijian,
			        sum(case when exportbytimedecide(c800020007,c700000007,c700000006)='是' then 1 else 0 end) as jishishu
			   from {WF:EL_LCT_Math} t1,{UltraProcess:SysGroup} g,{UltraProcess:SysUser} u
			  where 1 = 1
			    and (t1.c700000010 <> '草稿' and t1.c700000010 <> '已作废')
                and t1.c800020004 = u.c630000003 and u.c630000015 = g.c1
                and t1.c700000006 >=#CreateDate# and t1.c700000006 <=#endDate#
			  group by g.c630000018, ltrim(g.c1,0)
			 ) rs1,
			 
			 (select g.c630000018 as dp,
			        ltrim(g.c1,0) as dpid,
			        count(*) as phoneAll, 
			        sum(case when t1.notetype = 1 then 1 else 0 end) as phoneTotal,
			        sum(case when t1.notetype = 2 then 1 else 0 end) as notNotes
			   from app_temporary_note t1,{UltraProcess:SysGroup} g,{UltraProcess:SysUser} u
			  where t1.state=1
                and t1.equipmentuser = u.c630000003 and u.c630000015 = g.c1
			    and t1.CREATETIME >='#CreateDate2#' and t1.CREATETIME <='#endDate2#'
			  group by g.c630000018, ltrim(g.c1,0)
			 ) rs2,
			   
			   (select distinct ltrim(g.c1,0) as id, g.c630000018 as gname
			     from {WF:EL_LCT_Math} t1,{UltraProcess:SysGroup} g,{UltraProcess:SysUser} u
			     where 1=1
	               and t1.c800020004 = u.c630000003 and u.c630000015 = g.c1
	               $directpar$
	             union 
	            select distinct ltrim(g.c1,0) as id, g.c630000018 as gname
				 from app_temporary_note t1,{UltraProcess:SysGroup} g,{UltraProcess:SysUser} u
				where 1=1
	              and t1.equipmentuser = u.c630000003 and u.c630000015 = g.c1
			      #dpids#
			  ) rs3,
			  ( select       g.c630000018 as dp,
			        ltrim(g.c1,0) as dpid,
			        count(distinct t1.c1) as total
			   from {WF:EL_LCT_Math} t1,{WF:App_DealProcess} d,{UltraProcess:SysGroup} g,{UltraProcess:SysUser} u
			  where 1 = 1
	            and t1.c1=d.c700020001
	            and t1.c700000001=d.c700020002
	            and d.c700020114 = ltrim(g.c1,0)
	            and d.c700020004<>'BEGIN'
	            and d.c700020017>0
	            and t1.c800020013-d.c700020017<7200
	            and t1.c800020013-d.c700020017>0
			    and (t1.c700000010 <> '草稿' and t1.c700000010 <> '已作废')
                and t1.c800020004 = u.c630000003 and u.c630000015 = g.c1
                and t1.c700000006 >=#CreateDate# and t1.c700000006 <=#endDate#
			  group by g.c630000018, ltrim(g.c1,0)) rs4
			     
			  where rs1.dpid(+)=rs3.id
			    and rs2.dpid(+)=rs3.id
			    and rs4.dpid(+)=rs3.id
			    and rs3.gname <> 'administrator'
			    order by fromTotals desc
				   
		  ]]>
		</select>
		
		<rptatribute>
			<title>
				<item>		
					<titlecol>	
						<text>专业部门</text>
						<rowspan>2</rowspan>
					</titlecol>	
					<titlecol>
						<text>工单通知</text>
						<colspan>7</colspan>
					</titlecol>	
					<titlecol>
						<text>电话通知</text>
						<colspan>2</colspan>
					</titlecol>	
					<titlecol>
						<text>未通知</text>
						<colspan>2</colspan>
					</titlecol>	
					<titlecol>
						<text>工程总次数</text>
						<rowspan>2</rowspan>
					</titlecol>	
					
				</item>
				<item>
				    <titlecol>	
				        <enabled>false</enabled>
						<text>专业部门</text>
					</titlecol>	
					<titlecol>
						<text>次数</text>
					</titlecol>	
					<titlecol>
						<text>工单派发率</text>
					</titlecol>		
					<titlecol>
						<text>质检合格数</text>
					</titlecol>	
					<titlecol>
						<text>工单派发合格率</text>
					</titlecol>
					<titlecol>
						<text>工单派发及时数</text>
					</titlecol>
					<titlecol>
						<text>工单派发及时率</text>
					</titlecol>
					<titlecol>
						<text>工单确认及时率</text>
					</titlecol>
					<titlecol>
						<text>次数</text>
					</titlecol>	
					<titlecol>
						<text>占工程比例</text>
					</titlecol>	
					<titlecol>
						<text>次数</text>
					</titlecol>	
					<titlecol>
						<text>占工程比例</text>
					</titlecol>
					<titlecol>
					    <enabled>false</enabled>
						<text>工程总次数</text>
					</titlecol>	
				</item>			
			</title>			
		</rptatribute>
	</sqlquery>
	<sqlquery name="selectWork1">
		<select>
			<![CDATA[ 
				select 
						/*COUNT*/
						t1.c700000011 as BaseSummary,
					   t1.c700000004 as FullName,
					   t1.c700000100 as Phone,
					   t1.c700000014 as BaseItems,
					   2		     as myhref,
					   t1.c1         as baseId,
					   to_char(to_date('19700101', 'yyyymmdd') +
						t1.c700000006 / 86400 + 8 / 24,
						'yyyy-mm-dd hh24:MI:ss')as BaseCreateDate,
					   to_char(to_date('19700101', 'yyyymmdd') +
						t1.c700000017 / 86400 + 8 / 24,
						'yyyy-mm-dd hh24:MI:ss') as StartTime,
					   to_char(to_date('19700101', 'yyyymmdd') +
						t1.c800020013 / 86400 + 8 / 24,
						'yyyy-mm-dd hh24:MI:ss')as FinishTime
						/*COUNT*/
			    from   {WF:EL_LCT_Math} t1,{UltraProcess:SysGroup} g,{UltraProcess:SysUser} u
			    where  1 = 1
			    	   and t1.c700000006 >=#CreateDate# and t1.c700000006 <=#endDate#
			    	   and t1.c800020004 = u.c630000003 and u.c630000015 = g.c1
			    	   and (t1.c700000010 <> '草稿' and t1.c700000010 <> '已作废')
                       #types#
                       #dpids#
			 ]]>
			 
		</select>
		<rptatribute>
			<title>
				<item>					
					<titlecol>	
						<text>工单主题</text>
					</titlecol>	
					<titlecol>
						<text>建单人</text>
					</titlecol>	
					<titlecol>
						<text>联系电话</text>
					</titlecol>		
					<titlecol>
						<isshow>false</isshow>
					</titlecol>	
					<titlecol>
						<isshow>false</isshow>
					</titlecol>	
					<titlecol>
						<isshow>false</isshow>
					</titlecol>	
					<titlecol>
						<text>建单时间</text>
					</titlecol>
					<titlecol>
						<text>计划开始时间</text>
					</titlecol>
					<titlecol>
						<text>计划结束时间</text>
					</titlecol>							
				</item>
			</title>			
		</rptatribute>
	</sqlquery>
	<sqlquery name="selectWork2">
		<select>
			<![CDATA[ 
				select 
						/*COUNT*/
						t1.TEMPORARY_TITLE as BaseSummary,
					   t1.CREATENAME      as FullName,
					   t1.PHONE           as Phone,
					   t1.EQUIPMENT       as BaseItems,
					   1                  as myhref,
					   t1.TEMPORARY_ID    as baseId,
					   t1.TEMPORARY_NOTICETIME  as BaseCreateDate,
					   t1.CREATETIME as StartTime,
					   t1.FINISHTIME as FinishTime
					   /*COUNT*/
			    from   app_temporary_note t1,{UltraProcess:SysGroup} g,{UltraProcess:SysUser} u
			    where  1 = 1
			      and t1.state=1
			      and t1.equipmentuser = u.c630000003 and u.c630000015 = g.c1
			      and t1.CREATETIME >='#CreateDate2#' and t1.CREATETIME <='#endDate2#'
                  #types#
                  #createdpid#
			 ]]>
		</select>
			<rptatribute>
			<title>
				<item>					
					<titlecol>	
						<text>工单主题</text>
					</titlecol>	
					<titlecol>
						<text>建单人</text>
					</titlecol>	
					<titlecol>
						<text>联系电话</text>
					</titlecol>		
					<titlecol>
						<isshow>false</isshow>
					</titlecol>	
					<titlecol>
						<isshow>false</isshow>
					</titlecol>	
					<titlecol>
						<isshow>false</isshow>
					</titlecol>	
					<titlecol>
						<text>建单时间</text>
					</titlecol>
					<titlecol>
						<text>计划开始时间</text>
					</titlecol>
					<titlecol>
						<text>计划结束时间</text>
					</titlecol>							
				</item>
			</title>			
		</rptatribute>
	</sqlquery>
		<sqlquery name="selectWork3">
		<select>
			<![CDATA[ 
			select 
			/*COUNT*/
				   rs1.BaseSummary as BaseSummary,
				   rs1.FullName    as FullName, rs1.Phone as Phone,
				   rs1.BaseItems   as BaseItems,rs1.myhref as myhref,
				   rs1.baseId      as baseId, rs1.BaseCreateDate as BaseCreateDate,
				   rs1.StartTime   as StartTime,
				   rs1.FinishTime  as FinishTime
				   /*COUNT*/
			from(
				select t1.TEMPORARY_TITLE as BaseSummary,
					   t1.CREATENAME      as FullName,
					   t1.PHONE           as Phone,
					   t1.EQUIPMENT       as BaseItems,
					   1                  as myhref,
					   to_char(t1.TEMPORARY_ID)   as baseId,
					   t1.TEMPORARY_NOTICETIME  as BaseCreateDate,
					   t1.CREATETIME as StartTime,
					   t1.FINISHTIME as FinishTime
			    from   app_temporary_note t1,{UltraProcess:SysGroup} g,{UltraProcess:SysUser} u
			    where  t1.state=1
			           and t1.equipmentuser = u.c630000003 and u.c630000015 = g.c1
			    	   and t1.CREATETIME >='#CreateDate2#' and t1.CREATETIME <='#endDate2#'
			    	   #createdpid#
                       
                union
                select t1.c700000011 as BaseSummary,
					   t1.c700000004 as FullName,
					   t1.c700000100 as Phone,
					   t1.c700000014 as BaseItems,
					   2		     as myhref,
					   t1.c1         as baseId,
					   to_char(to_date('19700101', 'yyyymmdd') +
						t1.c700000006 / 86400 + 8 / 24,
						'yyyy-mm-dd hh24:MI:ss')as BaseCreateDate,
					   to_char(to_date('19700101', 'yyyymmdd') +
						t1.c700000017 / 86400 + 8 / 24,
						'yyyy-mm-dd hh24:MI:ss') as StartTime,
					   to_char(to_date('19700101', 'yyyymmdd') +
						t1.c800020013 / 86400 + 8 / 24,
						'yyyy-mm-dd hh24:MI:ss')as FinishTime
			    from   {WF:EL_LCT_Math} t1,{UltraProcess:SysGroup} g,{UltraProcess:SysUser} u
			    where  1=1 
			    	   and t1.c700000006 >=#CreateDate# and t1.c700000006 <=#endDate#
			    	   and (t1.c700000010 <> '草稿' and t1.c700000010 <> '已作废')
			    	   and t1.c800020004 = u.c630000003 and u.c630000015 = g.c1
			    	   #dpids#
			    	   ) rs1
                       
			 ]]>
		</select>
			<rptatribute>
			<title>
				<item>					
					<titlecol>	
						<text>工单主题</text>
					</titlecol>	
					<titlecol>
						<text>建单人</text>
					</titlecol>	
					<titlecol>
						<text>联系电话</text>
					</titlecol>		
					<titlecol>
						<isshow>false</isshow>
					</titlecol>	
					<titlecol>
						<isshow>false</isshow>
					</titlecol>	
					<titlecol>
						<isshow>false</isshow>
					</titlecol>	
					<titlecol>
						<text>建单时间</text>
					</titlecol>
					<titlecol>
						<text>计划开始时间</text>
					</titlecol>
					<titlecol>
						<text>计划结束时间</text>
					</titlecol>							
				</item>
			</title>			
		</rptatribute>
	</sqlquery>
	
</sql-group>
